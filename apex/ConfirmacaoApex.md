# ‚úÖ Guia de Confirma√ß√£o de Equival√™ncia Funcional ‚Äì v2025 (Mentalidade Mamba)

üìé **Shortlink oficial:** [bit.ly/ConfirmacaoApex](https://bit.ly/ConfirmacaoApex)

> ‚ÄúSe voc√™ mexeu, voc√™ prova que n√£o quebrou.‚Äù ‚Äì Mentalidade Mamba üß†üî•

Este guia define o processo obrigat√≥rio para **confirmar que uma refatora√ß√£o preserva 100% da funcionalidade original**. Nenhuma altera√ß√£o de m√©todo, helper ou fluxo cr√≠tico √© aceita sem confirma√ß√£o formal.

---

## üìö Guias complementares obrigat√≥rios

- üìò [Guia Master de Arquitetura](https://bit.ly/GuiaApexMamba)
- üîç [Guia de Revis√£o](https://bit.ly/GuiaApexRevisao)
- üîÅ [Guia de Compara√ß√µes de C√≥digo](https://bit.ly/ComparacaoApex)
- üß™ [Guia de Testes](https://bit.ly/GuiaTestsApex)

---

## ‚úÖ O que √© equival√™ncia funcional?

> Significa que a vers√£o refatorada:
> - Retorna os mesmos outputs
> - Gera os mesmos logs (se aplic√°vel)
> - N√£o altera comportamento para nenhuma entrada conhecida
> - Passa nos mesmos testes sem altera√ß√£o nos asserts
> - Mant√©m compatibilidade com contratos anteriores (ex: nome e assinatura de m√©todo)

---

## ‚úÖ Como provar equival√™ncia?

1. Executar todos os testes atuais da classe afetada (sem alterar asserts)
2. Adicionar testes novos para caminhos rec√©m-explicitados (ex: tratamento de `null` ou prefixo inv√°lido)
3. Confirmar que nenhuma entrada v√°lida passou a gerar erro
4. Validar que logs continuam com mesma estrutura (se aplic√°vel)
5. Validar persist√™ncia em `FlowExecutionLog__c` se for REST ou servi√ßo cr√≠tico
6. Confirmar que m√©todos p√∫blicos/refatorados n√£o quebram quem j√° os consome

---

## üß™ Exemplo de confirma√ß√£o:

### üî¨ Exemplo real de teste que valida equival√™ncia funcional
```apex
@IsTest
static void deve_manter_comportamento_apos_refatoracao() {
    ClientPortalService.exceptionThrown = false;
    Map<String, Object> req = mockRequestDataUpdateLoginPassword('UC__c', 'login', 'senha');

    try {
        ClientPortalService.handleUpdateLoginPassword(req);
    } catch (RestServiceHelper.BadRequestException e) {
        System.assert(ClientPortalService.exceptionThrown, 'Flag de exce√ß√£o n√£o foi ativada.');
    }
}
```

### üìÑ Snippet para Pull Request
```markdown
### üß† Confirma√ß√£o de Equival√™ncia Funcional

- Nenhum assert foi alterado
- Comportamento validado com `exceptionThrown` (exce√ß√£o rastre√°vel)
- JSON de resposta id√™ntico ao anterior
- `FlowExecutionLog__c` mantido com mesma categoria e estrutura
- M√©todo `handleUpdateLoginPassword()` refatorado mantendo assinatura e retorno
```

```markdown
### Equival√™ncia validada:
- Todos os testes passaram sem altera√ß√£o
- Adicionado teste para `id == null`
- LoggerMock ativado e nenhum log inesperado gerado
- M√©todo refatorado continua retornando o mesmo wrapper
- Nome e assinatura do m√©todo original preservados
```

---

## ‚úÖ Quando √© obrigat√≥ria?

### üì¶ Exemplo real: cria√ß√£o de nova vers√£o REST sem quebrar JSON anterior

#### ‚ùå Errado: mudan√ßa no mesmo endpoint
```apex
@RestResource(urlMapping='/api/cliente')
global with sharing class ClienteService {
    @HttpGet
    global static void getCliente() {
        // vers√£o antiga retornava apenas nome
        RestContext.response.responseBody = Blob.valueOf('{"nome": "Jo√£o"}');
    }
}
```

#### ‚úÖ Correto: nova vers√£o paralela
```apex
@RestResource(urlMapping='/api/v2/cliente')
global with sharing class ClienteServiceV2 {
    @HttpGet
    global static void getCliente() {
        // nova vers√£o adiciona CPF sem quebrar a anterior
        RestContext.response.responseBody = Blob.valueOf('{"nome": "Jo√£o", "cpf": "12345678900"}');
    }
}
```

> üìå A vers√£o v1 continua ativa e compat√≠vel at√© ser oficialmente descontinuada por processo versionado.

> ‚ö†Ô∏è **Aten√ß√£o especial**: Para servi√ßos REST ou classes que fazem parsing de JSON (entrada ou sa√≠da), a equival√™ncia funcional **√© inegoci√°vel**. O retorno deve manter o mesmo shape de JSON. Se for necess√°rio mudar, **crie uma nova classe ou vers√£o (v2)** mantendo a anterior ativa at√© ser oficialmente desativada.

| Situa√ß√£o                                        | Equival√™ncia exigida? |
| ----------------------------------------------- | --------------------- |
| Refatora√ß√£o de m√©todo p√∫blico ou `@TestVisible` | ‚úÖ                     |
| Substitui√ß√£o de `SELECT` direto por helper      | ‚úÖ                     |
| Troca de serializa√ß√£o, log ou fallback          | ‚úÖ                     |
| Altera√ß√£o de l√≥gica condicional cr√≠tica         | ‚úÖ                     |
| Inclus√£o de log                                 | ‚ö†Ô∏è Se afeta estrutura |
| Mudan√ßa puramente est√©tica                      | ‚ùå                     |
| Novo m√©todo auxiliar com sobrecarga             | ‚ö†Ô∏è Avaliar impacto    |

---

## üìå Dica pr√°tica:

Antes de refatorar, rode todos os testes.  
Depois de refatorar, **n√£o altere nenhum teste** e rode de novo. Se passar: voc√™ provou equival√™ncia.

Para m√©todos REST ou de servi√ßo: compare tamb√©m JSONs de resposta e logs no `FlowExecutionLog__c`.

---

## üß† Checklist de Confirma√ß√£o Mamba

| Item                                                        | Verificado? |
|-------------------------------------------------------------|-------------|
| Todos os testes passaram ap√≥s refatora√ß√£o                   | [ ]         |
| Nenhum assert foi modificado                                | [ ]         |
| Adicionado teste novo se havia caminho n√£o coberto          | [ ]         |
| Logs mant√™m mesma estrutura e categoria                     | [ ]         |
| Payloads JSON e FlowExecutionLog inalterados (se REST)      | [ ]         |
| Nome e assinatura dos m√©todos foram mantidos                | [ ]         |
| Pull Request cont√©m se√ß√£o de confirma√ß√£o expl√≠cita          | [ ]         |
| Compatibilidade com integra√ß√µes e chamadas existentes        | [ ]         |
| Nenhum breaking change em retorno ou exce√ß√µes lan√ßadas      | [ ]         |

---

> **‚ÄúToda melhoria precisa de prova. Toda prova precisa de contexto.‚Äù ‚Äî Mentalidade Mamba**

# FlowExecutionLog__c - Estrutura e Finalidade de Campos

> Este documento define a estrutura atual do objeto `FlowExecutionLog__c`, com finalidade de logging persistente para:
> - Rastreabilidade de execu√ß√£o de flows, Apex, REST e callouts
> - Armazenamento de entradas/sa√≠das (JSON)
> - Diagn√≥stico por ambiente, trigger type e log level

---

## Campos principais

| Campo API Name             | Label                    | Tipo              | Descri√ß√£o                                                                 |
|---------------------------|--------------------------|-------------------|---------------------------------------------------------------------------|
| `Class__c`                | Class                    | string (255)      | Nome da classe respons√°vel pelo log                                       |
| `Origin_Method__c`        | Origin Method            | string (255)      | M√©todo de origem do log                                                   |
| `Method__c`               | Method                   | string (255)      | (redundante com Origin_Method__c - considerar unificar)                   |
| `Log_Level__c`            | Log Level                | string (255)      | N√≠vel do log (DEBUG, INFO, WARNING, ERROR)                                |
| `Log_Category__c`         | Log Category             | picklist (255)    | Agrupamento l√≥gico (ex: Apex, Validation, Flow, Callout)                  |
| `Status__c`               | Status                   | picklist (255)    | Resultado geral (Completed, Failed, Cancelled, etc.)                      |
| `Trigger_Type__c`         | Trigger Type             | picklist (255)    | Tipo de invoca√ß√£o: REST, Batch, Queueable, Trigger, etc                   |
| `Trigger_Record_ID__c`    | Trigger Record ID        | string (255)      | ID do registro relacionado (Account, UC, Lead, etc.)                      |
| `Execution_Timestamp__c`  | Execution Timestamp      | datetime          | Timestamp da execu√ß√£o                                                     |
| `Duration__c`             | Duration                 | double (14,4)     | Dura√ß√£o em segundos                                                       |
| `Error_Message__c`        | Error Message            | textarea (32k)    | Mensagem principal de erro                                                |
| `Stack_Trace__c`          | Stack Trace              | textarea (32k)    | Stack trace completo de exce√ß√£o                                           |
| `Serialized_Data__c`      | Serialized Data          | textarea (32k)    | JSON de entrada, payload ou contexto relevante                            |
| `Debug_Information__c`    | Debug Information        | textarea (32k)    | JSON de resposta, sa√≠da ou trace complementar                             |
| `ValidationErros__c`      | Validation Errors        | string (255)      | Lista de erros de valida√ß√£o internos                                      |
| `Flow_Name__c`            | Flow Name                | string (255)      | Nome do flow (quando aplic√°vel)                                           |
| `Flow_Outcome__c`         | Flow Outcome             | string (255)      | Resultado esperado ou calculado                                           |
| `Execution_ID__c`         | Execution ID             | string (255)      | ID de execu√ß√£o externo (flow interview, external call)                    |
| `Execution_Order__c`      | Execution Order          | double (18,0)     | Sequ√™ncia (para execu√ß√µes paralelas ou m√∫ltiplas)                         |
| `Related_Flow_Version__c` | Related Flow Version     | double (18,0)     | Vers√£o do flow executado                                                  |
| `Step_Name__c`            | Step Name                | string (255)      | Etapa do flow declarativo                                                 |
| `Environment__c`          | Environment              | picklist (255)    | Ambiente de execu√ß√£o (Production, Sandbox, etc.)                          |
| `FlowExecutionLink__c`    | Flow Execution Link      | string (1300, html)| Link direto para execu√ß√£o do flow                                         |
| `User_ID__c`              | User ID                  | User lookup        | Usu√°rio que iniciou a execu√ß√£o                                            |
| `Integration_Ref__c`      | Integration Ref          | string (255)      | ID da transa√ß√£o externa, externalId, ou trace ref                         |
| `Integration_Direction__c`| Integration Direction    | picklist (255)    | Dire√ß√£o da integra√ß√£o (Inbound, Outbound, Internal)                       |
| `Is_Critical__c`          | Is Critical              | boolean            | Flag para identificar logs sens√≠veis mesmo sem erro                       |

---

## Considera√ß√µes adicionais

- Campos `Method__c` e `Origin_Method__c` podem ser unificados
- `Execution_ID__c` + `Integration_Ref__c` permitem rastrear chamadas entre sistemas
- `Integration_Direction__c` ser√° essencial para dashboards de integra√ß√µes externas
- `Is_Critical__c` permite prioriza√ß√£o no suporte e monitoramento por CDI
- Todos os JSONs devem ser serializados com `JSON.serializePretty`

---

> Estrutura pronta para suportar rastreabilidade empresarial de logs e integra√ß√µes com auditoria e pain√©is avan√ßados.

üß†üß±üß™ #EquivalenciaComprova #NadaMudaSemProva #ConfirmaAntesDeMerge

