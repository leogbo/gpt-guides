************** PENDENCIAS PARA INTEGRAR ****************

üÜï Regra de refor√ßo:
‚ùó Nenhum dado em TestDataSetup pode impedir a execu√ß√£o de valida√ß√µes obrigat√≥rias
Exemplo: recordId em branco deve ser validado, mesmo se TestDataSetup normalmente criar tudo certo

************** FRIM DAS PENDENCIAS ****************

A seguir est√° a vers√£o **refatorada e atualizada do Guia Rigoroso de TestDataSetup (2025)**, j√° ajustada para:

- Padr√£o v2 do ecossistema Logger  
- Uso estrito de `@TestSetup`  
- Proibi√ß√£o definitiva de `Logger` dentro de setup  
- Cache, reutiliza√ß√£o defensiva, isolamento de dados e nomes-chave claros  

---

# üß± Guia Rigoroso de TestDataSetup ‚Äì v2025

> üåê Base: https://bit.ly/TestDataSetup

üìé Guias complementares:
- üìò [Guia de Revis√£o Apex](https://bit.ly/GuiaApexRevisao)
- üß™ [Guia de Testes Apex](https://bit.ly/GuiaTestsApex)
- ü™µ [Guia de Logger v2](https://bit.ly/GuiaLoggerApex)
- üîÅ [Template de Refatora√ß√£o](https://bit.ly/ComparacaoApex)
- ‚úÖ [Checklist de Equival√™ncia](https://bit.ly/ConfirmacaoApex)

---

## ‚úÖ Objetivo

Estabelecer padr√£o √∫nico, seguro e reutiliz√°vel para cria√ß√£o de dados de teste em Apex.  
A classe `TestDataSetup.cls` atua como **orquestradora universal de dados em `@TestSetup`**, garantindo isolamento, rastreabilidade e escalabilidade.

---

## ‚öñÔ∏è Regras Inviol√°veis

### 1. Uso exclusivo em `@TestSetup`
- ‚úÖ Deve ser usada **apenas dentro de `@TestSetup`**
- ‚ùå Proibido usar `setupCompleteEnvironment()` em testes individuais
- ‚ùå Nunca reutilizar o `Map<String, SObject>` entre testes

---

### 2. Proibi√ß√µes cr√≠ticas
| Item                                  | Status     |
|---------------------------------------|------------|
| Uso de `Logger`                       | ‚ùå Proibido |
| Uso de `LoggerMock`                   | ‚ùå Proibido |
| Uso de `System.debug()`               | ‚ö†Ô∏è **Permitido somente para debug local isolado** |
| Logging dentro de `TestDataSetupTest`| ‚ùå Proibido |

---

### 3. Toda cria√ß√£o de dados deve ser delegada
- ‚úÖ Cada entidade tem seu `*TestDataSetup` especializado
- Exemplo:
  - `LeadTestDataSetup`, `GeradorTestDataSetup`, `UserTestDataSetup`, etc.
- `TestDataSetup` s√≥ orquestra ‚Äî **nunca insere diretamente objetos compostos**

---

## üß™ Exemplo de uso nos testes

```apex
@TestSetup
static void setupData() {
    TestDataSetup.setupCompleteEnvironment();
    FlowControlManager.disableFlows();
    Logger.isEnabled = false;
}
```

```apex
@IsTest
static void meuTeste() {
    Account acc = [SELECT Id FROM Account LIMIT 1];
    // seguir com valida√ß√£o
}
```

---

## üì¶ Boas pr√°ticas de uso

| Tema                     | Pr√°tica recomendada                                       |
|--------------------------|-----------------------------------------------------------|
| üîë Nomes no Map          | Use `LeadPF`, `Distribuidora`, `Opportunity`, etc.        |
| üîÑ Map transit√≥rio       | Use apenas dentro do `@TestSetup`, **nunca fora dele**     |
| üß† Cache inteligente     | Em `*TestDataSetup`: cache de `RecordType`, `Profile`, etc. |
| ‚ôªÔ∏è Clean defensivo       | Use `TestDataSetup.cleanUp()` ou `fullCleanUpAllSupportedObjects()` |

---

## üìê Estrutura obrigat√≥ria da classe `TestDataSetup`

### 1. M√©todo principal
```apex
@TestVisible
public static Map<String, SObject> setupCompleteEnvironment() {
    // Orquestra chamadas a outros *TestDataSetup
    return createdRecords;
}
```

### 2. M√©todos auxiliares

```apex
@TestVisible
public static void overrideLabel(String labelName, String value)

@TestVisible
public static void cleanUp(List<SObject> records)

@TestVisible
public static void fullCleanUpAllSupportedObjects()
```

---

## ‚úÖ Checklist Mamba para TestDataSetup.cls

- [ ] Possui `setupCompleteEnvironment()` com `@TestVisible`
- [ ] N√£o usa `Logger`, nem `LoggerMock`
- [ ] Nenhum `System.debug()` fora de casos de exce√ß√£o
- [ ] Usa delega√ß√µes para `*TestDataSetup`
- [ ] N√£o armazena o `Map<String, SObject>` entre testes
- [ ] Nenhum m√©todo √© chamado fora do `@TestSetup`

---

## üß† Lembrete estrat√©gico

> `TestDataSetup` **n√£o existe para "facilitar os testes", mas para blindar sua su√≠te inteira contra depend√™ncia cruzada, setup quebrado e dados injetados via seeAllData.**

## Conteudo explicito da vers√£o atual de TestDataSetup.cls


// @isTest
public class TestDataSetup {

    private static final String MOCK_DOMINIO = 'https://mock-dominio.com';
    private static final String MOCK_URL     = 'https://mock-token.com/oauth';

    @TestVisible
    public class TestSetupException extends Exception {}

    @TestVisible
    private static Map<String, String> testLabels = new Map<String, String>();

    @TestVisible
    public static void overrideLabel(String labelName, String value) {
        if (Test.isRunningTest()) {
            testLabels.put(labelName, value);
        } else {
            throw new TestSetupException('Override de Label n√£o permitido em produ√ß√£o.');
        }
    }

    @TestVisible
    public static String getLabel(String labelName) {
        return testLabels.containsKey(labelName) ? testLabels.get(labelName) : null;
    }

    @TestVisible
    public static Integracao__c createIntegracao() {

        try {
            List<Integracao__c> existentes = [SELECT Id FROM Integracao__c LIMIT 1];

            if (!existentes.isEmpty()) {
                return existentes[0];
            }

            Integracao__c integracao = new Integracao__c(
                Dominio__c       = MOCK_DOMINIO,
                clientId__c      = 'mockClientId' + String.valueOf(System.currentTimeMillis()).right(8),
                clientSecret__c  = 'mockSecret'   + String.valueOf(System.currentTimeMillis()).right(8),
                username__c      = 'usuario'      + String.valueOf(System.currentTimeMillis()).right(8),
                password__c      = 'senha'        + String.valueOf(System.currentTimeMillis()).right(8),
                url__c           = MOCK_URL
            );

            insert integracao;
            return integracao;

        } catch (Exception ex) {
            throw ex;
        }
    }

    @TestVisible
    public static Map<String, SObject> setupCompleteEnvironment() {

        Map<String, SObject> createdRecords = new Map<String, SObject>();

        try {
            User user = UserTestDataSetup.createUser();
            Configuracoes__c responsavel = ResponsavelTestDataSetup.createResponsavel(user.Id);
            Integracao__c integracao = createIntegracao();

            Vertical__c vertical = VerticalTestDataSetup.createVertical('Ultragaz Energia');
            Originador__c originadorPai = OriginadorTestDataSetup.createOriginador(vertical.Id, null);
            Originador__c originadorFilho = OriginadorTestDataSetup.createOriginadorFilho(vertical.Id, null, originadorPai.Id);

            Distribuidora__c distribuidora = DistribuidoraTestDataSetup.createDistribuidora();
            Tarifa_Distribuidora__c tarifa = DistribuidoraTestDataSetup.createTarifaDistribuidora(distribuidora);

            Gerador__c gerador = GeradorTestDataSetup.createGerador();
            Veiculo__c veiculo = GeradorTestDataSetup.createVeiculo(gerador.Id, null);
            Plataforma_de_Cobranca__c plataforma = GeradorTestDataSetup.createPlataformaCobranca(veiculo.Id, 'itau');
            Produto_do_Gerador__c produto = GeradorTestDataSetup.createProdutoDoGerador(vertical.Id, veiculo.Id, distribuidora.Id, plataforma.Id);
            
            Usina__c usina = UsinaTestDataSetup.createUsina(distribuidora.Id, gerador.Id, veiculo.Id);
            Fatura_da_Usina__c faturaUsina = UsinaTestDataSetup.createFaturaDaUsina(usina.Id, Date.today().toStartOfMonth());
            List<Geracao__c> geracoes = UsinaTestDataSetup.createGeracoesParaUsina(usina.Id, Date.today().addMonths(-2), Date.today());

            Lead leadPF = LeadTestDataSetup.createLeadPfQualificando(originadorPai.Id, distribuidora.Id);
            Lead leadPJ = LeadTestDataSetup.createLeadPjQualificando(originadorFilho.Id, distribuidora.Id, null);

            Account account = AccountTestDataSetup.createAccount(vertical.Id, originadorFilho.Id, null, '34.363.771/0001-65');
            Contact contact = AccountTestDataSetup.createContact(account.Id, null, null, null, null, null);

            Opportunity opportunity = OpportunityTestDataSetup.createOpportunity(account.Id, produto.Id, contact.Id);
            Proposta__c proposta = PropostaTestDataSetup.createProposta(opportunity.Id);
            
            Documento_da_Conta__c docConta = DocumentoTestDataSetup.createDocConta(account.Id, null, null, null);
            Documento_do_Contato__c docContato = DocumentoTestDataSetup.createDocContato(contact.Id, null, null, null);
            Documento_da_Proposta__c docProposta = DocumentoTestDataSetup.createDocProposta(proposta.Id, null, null, null);
            Documento_da_Oportunidade__c docOportunidade = DocumentoTestDataSetup.createDocOportunidade(opportunity.Id, null, null);
            
            Signatario_do_Gerador__c signGerador = SignatarioTestDataSetup.createSignatarioGerador(gerador.Id, contact.Id);
            Signatario_da_Oportunidade__c signOpp = SignatarioTestDataSetup.createSignatarioOportunidade(docOportunidade.Id, contact.Id);
            
            Contrato_de_Adesao__c contrato = UcTestDataSetup.createContratoDeAdesao(account.Id, contact.Id, veiculo.Id);
            UC__c uc = UcTestDataSetup.createUC(contrato.Id, produto.Id, proposta.Id);
            Contato_da_UC__c contatoDaUc = UcTestDataSetup.createContatoDaUC(uc.Id, uc.Rep_Legal__c, null);
            
            Fatura__c faturaUc = UcTestDataSetup.createFatura(uc.Id, Date.today().toStartOfMonth());
            Cobranca__c cobranca = CobrancaTestDataSetup.createCobranca(uc.Id, null, 1000, null);
            
            Case caseRecord = CaseTestDataSetup.createCase(uc.Id);

            createdRecords.put('User', user);
            createdRecords.put('Responsavel', responsavel);
            createdRecords.put('Integracao', integracao);
            createdRecords.put('Vertical', vertical);
            createdRecords.put('Originador', originadorPai);
            createdRecords.put('OriginadorPai', originadorPai);
            createdRecords.put('OriginadorFilho', originadorFilho);
            createdRecords.put('Distribuidora', distribuidora);
            createdRecords.put('TarifaDistribuidora', tarifa);
            createdRecords.put('Gerador', gerador);
            createdRecords.put('Veiculo', veiculo);
            createdRecords.put('Plataforma', plataforma);
            createdRecords.put('Produto', produto);
            createdRecords.put('Usina', usina);
            createdRecords.put('LeadPF', leadPF);
            createdRecords.put('LeadPJ', leadPJ);
            createdRecords.put('Account', account);
            createdRecords.put('Contact', contact);
            createdRecords.put('Opportunity', opportunity);
            createdRecords.put('Proposta', proposta);
            createdRecords.put('DocConta', docConta);
            createdRecords.put('DocContato', docContato);
            createdRecords.put('DocProposta', docProposta);
            createdRecords.put('DocOportunidade', docOportunidade);
            createdRecords.put('SignatarioGerador', signGerador);
            createdRecords.put('SignatarioOportunidade', signOpp);
            createdRecords.put('Contrato', contrato);
            createdRecords.put('UC', uc);
            createdRecords.put('ContatoDaUc', contatoDaUc);
            createdRecords.put('Cobranca', cobranca);
            createdRecords.put('Case', caseRecord);
            createdRecords.put('FaturaUC', faturaUc);
            createdRecords.put('FaturaUsina', faturaUsina);
            createdRecords.put('Geracoes', geracoes[0]);

            return createdRecords;

        } catch (Exception ex) {
            throw ex;
        }
    }

    @TestVisible
    public static void cleanUp(List<SObject> records) {

        try {
            if (records == null || records.isEmpty()) {
                return;
            }

            Map<String, List<SObject>> grouped = new Map<String, List<SObject>>();
            for (SObject s : records) {
                String tipo = String.valueOf(s.getSObjectType());
                if (!grouped.containsKey(tipo)) grouped.put(tipo, new List<SObject>());
                grouped.get(tipo).add(s);
            }

            Integer totalDeleted = 0;
            for (List<SObject> listToDelete : grouped.values()) {
                if (!listToDelete.isEmpty()) {
                    String tipo = String.valueOf(listToDelete[0].getSObjectType());
                    if (tipo == 'User') continue;
                    try {
                        delete listToDelete;
                        totalDeleted += listToDelete.size();
                    } catch (DmlException dex) {
                        if (!dex.getMessage().contains('ENTITY_IS_DELETED')) {
                            throw dex;
                        }
                    }
                }
            }

        } catch (Exception ex) {
            throw ex;
        }
    }

    @TestVisible
    public static void fullCleanUpAllSupportedObjects() {

        try {
            List<List<SObject>> batches = new List<List<SObject>>();
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Geracao__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Fatura_da_Usina__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Fatura__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Contato_da_UC__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM UC__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Contrato_de_Adesao__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Documento_da_Oportunidade__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Documento_da_Proposta__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Documento_do_Contato__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Documento_da_Conta__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Signatario_da_Oportunidade__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Signatario_do_Gerador__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Proposta__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Opportunity')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Contact')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Account')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Lead')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Usina__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Produto_do_Gerador__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Plataforma_de_Cobranca__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Veiculo__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Gerador__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Tarifa_Distribuidora__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Distribuidora__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Originador__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Vertical__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Configuracoes__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Integracao__c')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Case')));
            batches.add(new List<SObject>(Database.query('SELECT Id FROM Cobranca__c')));

            Integer totalDeleted = 0;
            for (List<SObject> listToDelete : batches) {
                if (!listToDelete.isEmpty()) {
                    String tipo = String.valueOf(listToDelete[0].getSObjectType());
                    if (tipo == 'User') continue;
                    try {
                        delete listToDelete;
                        totalDeleted += listToDelete.size();
                    } catch (DmlException dex) {
                        if (!dex.getMessage().contains('ENTITY_IS_DELETED')) {
                            throw dex;
                        }
                    }
                }
            }

        } catch (Exception ex) {
            throw ex;
        }
    }
}
